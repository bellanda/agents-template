---
description: "[Agents Template] Overview - architecture, structure, conventions. Copy .cursor/rules/ to other projects."
alwaysApply: true
---

# Agents Template – Overview

Multi-agent backend (FastAPI + LangGraph) with dashboard (TanStack Router SPA + Shadcn). Copy this repo or `.cursor/rules/agents-template-*.mdc` to bootstrap new projects.

## ⚠️ Production Warnings

**This template is designed for development and MUST be adapted for production:**

1. **User Authentication:**
   - **Frontend**: Default user `"default_user"` via `useUserId()` hook
   - **Backend**: Default user `"default_user"` if `ChatRequest.user` is not provided
   - **Action Required**: Replace with your authentication system (JWT, OAuth, session-based, etc.)
   - See `frontend/src/hooks/useUserId.ts` and backend `api/routes/agents/chat.py`

2. **Database:**
   - **Checkpointer**: SQLite (`data/checkpoints.db`) for LangGraph agent state
   - **History**: SQLite (`data/history.db`) for thread metadata
   - **Action Required**: 
     - For single-instance deployments: SQLite is acceptable but not ideal
     - For distributed systems: Replace with PostgreSQL, MySQL, or your production database
     - Update `config/checkpointer.py` to use production checkpointer (e.g., `PostgresSaver`)
     - Update `api/services/agents/history.py` to use production database

3. **File Paths:**
   - Ensure `config/paths.py` points to correct `BASE_DIR` in your project structure
   - Database paths assume `data/` directory exists at backend root

4. **API Keys:**
   - Store in environment variables, never commit to git
   - See `config/api_keys.py` for required keys
   - Use `.env` file (gitignored) for local development

5. **CORS:**
   - Template allows all origins (`allow_origins=["*"]`) for development
   - **Production**: Restrict to your frontend domain(s)

---

## Architecture

```
Backend :8000                    Frontend :3000
POST /api/v1/agents/chat/completions  ← useChat + DefaultChatTransport
GET  /api/v1/agents                  ← list agents (id, name, description, mode)
GET/DELETE /api/v1/agents/threads    ← conversation history (chat-mode only)
       ↓
Agent Registry (auto-discovers agents/) → Stream (SSE) → SQLite Checkpointer
```

**Data Flow:**
1. Frontend sends request via `DefaultChatTransport` to `/api/v1/agents/chat/completions`
2. Backend routes to `chat.py` endpoint
3. Registry looks up agent by `model_id`
4. Agent executes via `stream_agent()` (streaming) or `execute_agent()` (non-streaming)
5. Streaming: SSE chunks sent to frontend via `StreamingResponse`
6. History saved to `history.db` if agent mode is `"chat"`
7. Checkpointer saves agent state to `checkpoints.db` if agent mode is `"chat"`

---

## Directory Structure

**Backend:**
```
backend/
├── agents/                    # One folder per agent
│   ├── weather_agent/
│   │   ├── agent.py          # Required: create_root_agent, AGENT_NAME, etc.
│   │   └── tools/            # Optional: agent-specific tools
│   └── web_search_agent/
│       ├── agent.py
│       └── tools/
├── src/api/
│   ├── routes/agents/        # API endpoints
│   │   ├── chat.py          # POST /chat/completions
│   │   ├── models.py        # GET /agents (list)
│   │   └── threads.py       # GET/DELETE /threads
│   └── services/agents/      # Business logic
│       ├── registry.py      # Agent discovery and loading
│       ├── streaming.py     # SSE streaming protocol
│       ├── executors.py     # Agent execution (non-streaming)
│       ├── history.py       # Thread history database
│       ├── tools.py         # Utility functions
│       └── utils.py         # File processing (MarkItDown)
├── config/                   # Configuration
│   ├── agents.py           # Model initialization (Chutes, Cerebras, etc.)
│   ├── api_keys.py         # API key management
│   ├── checkpointer.py     # LangGraph checkpointer (SQLite)
│   ├── paths.py            # Path configuration (BASE_DIR)
│   └── prompt_cache.py     # Prompt caching utilities
├── scripts/                  # Utility scripts
│   ├── sync_agents_to_another_fastapi_project.py
│   └── uv_upgrade_pyproject_dependencies.py
├── data/                     # Database files (gitignored)
│   ├── checkpoints.db       # LangGraph checkpointer
│   └── history.db           # Thread metadata
└── main.py                   # FastAPI app + lifespan
```

**Frontend:**
```
frontend/
├── src/
│   ├── routes/               # TanStack Router (file-based)
│   │   ├── __root.tsx       # ThemeProvider wrapper
│   │   ├── index.tsx        # Home page
│   │   ├── chat/$agentId.tsx # Chat mode route
│   │   └── agent/$agentId.tsx # Single-shot route
│   ├── components/
│   │   ├── ChatView.tsx     # Main chat component
│   │   ├── layouts/         # Layout components
│   │   │   └── sidebar-layout.tsx
│   │   ├── sidebar/         # Sidebar components
│   │   │   └── app-sidebar.tsx
│   │   ├── ai-elements/     # Vercel AI Elements (auto-generated)
│   │   └── ui/              # Shadcn/ui components
│   ├── hooks/
│   │   └── useUserId.ts     # User ID hook (replace with auth)
│   ├── lib/
│   │   └── api.ts           # API utilities
│   └── styles.css           # Global styles + Streamdown
├── vite.config.ts           # Vite config + proxy
└── package.json
```

**Cursor Rules:**
```
.cursor/rules/
├── agents-template-overview.mdc              # This file
├── agents-template-backend-agents-api.mdc   # Backend rules
└── agents-template-frontend-chat-dashboard.mdc # Frontend rules
```

---

## Conventions

### Python (Backend)
- **Package Manager**: `uv` only. NEVER use pip, poetry, pipenv, or conda.
- **Commands**: `uv run <cmd>`, `uv sync`, `uv add <package>`, `uv remove <package>`
- **Type Hints**: Required on all public functions and methods
- **Modern Syntax**: `list[str]` over `List[str]`, `dict[str, int]` over `Dict[str, int]`, `X | None` over `Optional[X]`
- **Async**: Use `async/await` for I/O operations
- **Code Style**: Follow PEP 8, prioritize readability

### TypeScript/React (Frontend)
- **Package Manager**: `bun` only. NEVER use npm, yarn, or pnpm.
- **Commands**: `bun dev`, `bun add <package>`, `bun install`, `bun run <script>`
- **TypeScript**: Full typing required (props, state, return types). Avoid `any`.
- **Naming**: `PascalCase` for components/interfaces/types, `camelCase` for functions/variables, `UPPER_CASE` for constants
- **Components**: Prefer functional components with hooks
- **Imports**: Use absolute imports with `@/` path alias
- **Styling**: Tailwind CSS ONLY for styling - NO custom CSS files
- **Responsive**: Mobile-first design (default styles for mobile, use `sm:`, `md:`, `lg:` for larger screens)

---

## Agent Modes

### Chat Mode (`AGENT_MODE = "chat"`)
- **Persistence**: Conversations persist via LangGraph checkpointer
- **History**: Threads saved to `history.db` for sidebar display
- **Session**: Each conversation has a `thread_id` (session_id)
- **User Scoping**: Threads filtered by `user_id` from checkpoint metadata
- **Use Case**: Multi-turn conversations, context-aware agents

### Single-Shot Mode (`AGENT_MODE = "single-shot"`)
- **Persistence**: No persistence, each request is independent
- **History**: No history saved
- **Session**: No session ID needed
- **Use Case**: One-off queries, stateless operations

---

## Streaming Protocol

**SSE (Server-Sent Events) compatible with Vercel AI SDK `DefaultChatTransport`.**

**Chunk order (strict):**
```
start → [reasoning-start → reasoning-delta* → reasoning-end] → text-start → text-delta* → text-end → finish → data: [DONE]\n\n
```

**Response headers:**
- `Content-Type: text/event-stream`
- `Cache-Control: no-cache`
- `Connection: keep-alive`
- `X-Accel-Buffering: no`
- `x-vercel-ai-ui-message-stream: v1` (required for AI SDK)

**Implementation:**
- Uses LangGraph `agent.astream_events()` with `version="v1"`
- Extracts `reasoning_content` from `chunk.additional_kwargs.get("reasoning_content", "")`
- Extracts `content` from chunk for text streaming
- Reasoning MUST come before text (SDK orders parts by first-seen start)

See `agents-template-backend-agents-api.mdc` for detailed implementation.

---

## Adapting to Different Project Structures

### Backend Structure Variations

**If your backend structure differs:**

1. **API Routes Location:**
   - Template: `src/api/routes/agents/`
   - Adapt: Update imports in `main.py` and router includes
   - Ensure routes are accessible via FastAPI router

2. **Services Location:**
   - Template: `src/api/services/agents/`
   - Adapt: Update imports in routes and services
   - Registry, streaming, executors must be importable

3. **Config Location:**
   - Template: `config/` at backend root
   - Adapt: Update `config/paths.py` to point to correct `BASE_DIR`
   - Ensure all config files are importable

4. **Agents Location:**
   - Template: `agents/` at backend root
   - Adapt: Update `config/paths.py` or registry discovery logic
   - Registry scans `BASE_DIR / "agents"` by default

5. **Database Paths:**
   - Template: `data/checkpoints.db` and `data/history.db`
   - Adapt: Update `config/checkpointer.py` and `api/services/agents/history.py`
   - Ensure `data/` directory exists or create it programmatically

**Use the sync script:**
```bash
uv run scripts/sync_agents_to_another_fastapi_project.py \
  --api-path /path/to/api \
  --backend-path /path/to/backend
```

The script will:
- Copy agents, routes, services, and config files
- Ask for confirmation before replacing identical files
- Automatically replace missing files
- Copy Cursor rules for documentation

### Frontend Structure Variations

**If your frontend structure differs:**

1. **Routes Location:**
   - Template: TanStack Router file-based in `src/routes/`
   - Adapt: Update route definitions and imports
   - Ensure routing library supports SPA mode

2. **Components Location:**
   - Template: `src/components/`
   - Adapt: Update import paths (`@/components/...`)
   - Ensure path alias `@/` → `src/` is configured

3. **API Endpoints:**
   - Template: `/api/v1/agents/*` (proxied to backend)
   - Adapt: Update fetch URLs or proxy configuration
   - Ensure CORS is configured on backend

4. **Build Tool:**
   - Template: Vite with Bun
   - Adapt: Update `vite.config.ts` for your setup
   - Ensure proxy configuration matches your backend URL

5. **Styling:**
   - Template: Tailwind v4 with Shadcn/ui
   - Adapt: Update Tailwind config and component imports
   - Ensure CSS imports are correct

---

## Integration Checklist

When integrating this template into a new project:

### Backend
- [ ] Copy agents, routes, services, and config files
- [ ] Update `config/paths.py` to point to correct `BASE_DIR`
- [ ] Configure API keys in `.env` file
- [ ] Update `main.py` lifespan if needed
- [ ] Replace SQLite checkpointer with production database (if needed)
- [ ] Replace SQLite history database with production database (if needed)
- [ ] Update CORS settings for production
- [ ] Integrate user authentication (extract `user_id` from JWT/session)
- [ ] Test agent discovery and loading
- [ ] Test streaming and non-streaming endpoints

### Frontend
- [ ] Copy routes, components, and hooks
- [ ] Configure path alias `@/` → `src/` in `tsconfig.json` and `vite.config.ts`
- [ ] Update Vite proxy to point to backend URL
- [ ] Replace `useUserId()` hook with your auth system
- [ ] Install dependencies: `bun install`
- [ ] Install AI Elements: `bunx ai-elements@latest add message conversation reasoning`
- [ ] Configure Tailwind and Shadcn/ui
- [ ] Test chat and single-shot modes
- [ ] Test history hydration and sidebar
- [ ] Test agent selector and suggestions

### Documentation
- [ ] Copy `.cursor/rules/agents-template-*.mdc` to your project
- [ ] Update rules with project-specific paths if needed
- [ ] Document any customizations made

---

## Dependencies

### Backend (Python)
```bash
uv add langgraph langchain langchain-core
uv add fastapi uvicorn
uv add aiosqlite orjson markitdown
uv add langchain-openai langchain-anthropic  # As needed
```

### Frontend (TypeScript)
```bash
bun add @ai-sdk/react ai streamdown
bun add @tanstack/react-router
bun add @radix-ui/react-*  # Shadcn/ui dependencies
bun add tailwindcss @tailwindcss/vite
bun add @phosphor-icons/react lucide-react
bunx ai-elements@latest add message conversation reasoning
```

---

## Getting Started

1. **Clone or copy this template**
2. **Backend setup:**
   ```bash
   cd backend
   uv sync
   cp .env.example .env  # Configure API keys
   uv run main.py
   ```

3. **Frontend setup:**
   ```bash
   cd frontend
   bun install
   bunx ai-elements@latest add message conversation reasoning
   bun dev
   ```

4. **Create your first agent:**
   ```bash
   mkdir -p backend/agents/my_agent
   # Create backend/agents/my_agent/agent.py with required exports
   ```

5. **Adapt for production:**
   - Replace user authentication
   - Replace SQLite with production database
   - Configure CORS for production
   - Update API endpoints if needed

---

## Support & Documentation

- **Backend Rules**: See `agents-template-backend-agents-api.mdc`
- **Frontend Rules**: See `agents-template-frontend-chat-dashboard.mdc`
- **AI Elements Docs**: https://elements.ai-sdk.dev/
- **LangGraph Docs**: https://langchain-ai.github.io/langgraph/
- **TanStack Router**: https://tanstack.com/router
